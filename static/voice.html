<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Voice Chat â€” LLM</title>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --border: #2a2d3a;
      --primary: #6c63ff;
      --primary-glow: rgba(108, 99, 255, .35);
      --danger: #ff4d6a;
      --text: #e4e4e7;
      --muted: #9ca3af;
      --radius: 14px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: .25rem;
    }

    .subtitle {
      color: var(--muted);
      font-size: .85rem;
      margin-bottom: 2rem;
    }

    /* â”€â”€ Chat log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chat {
      width: 100%;
      max-width: 640px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: .75rem;
      margin-bottom: 1.5rem;
      padding-right: .25rem;
    }

    .msg {
      padding: .85rem 1.1rem;
      border-radius: var(--radius);
      max-width: 85%;
      line-height: 1.55;
      font-size: .92rem;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .msg.user {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .msg.assistant {
      align-self: flex-start;
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .msg.system {
      align-self: center;
      color: var(--muted);
      font-size: .8rem;
      background: transparent;
    }

    /* â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    #startBtn {
      border: none;
      border-radius: 999px;
      padding: 0.85rem 1.5rem;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(108, 99, 255, .25);
    }

    #textForm {
      width: 100%;
      max-width: 640px;
      margin-top: 1.5rem;
      display: flex;
      gap: .75rem;
    }

    #textForm textarea {
      flex: 1;
      min-height: 70px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: .8rem;
      color: var(--text);
      font-size: .95rem;
      resize: vertical;
    }

    #textForm button {
      border: none;
      border-radius: 12px;
      padding: 0 1.2rem;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    #micBtn {
      width: 72px;
      height: 72px;
      border: none;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      font-size: 1.8rem;
      cursor: pointer;
      transition: box-shadow .2s, transform .15s, background .2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #micBtn:hover { transform: scale(1.06); }

    #micBtn.recording {
      background: var(--danger);
      box-shadow: 0 0 0 6px rgba(255, 77, 106, .3);
      animation: pulse 1.2s infinite;
    }

    #micBtn:disabled {
      opacity: .35;
      cursor: not-allowed;
      box-shadow: none;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 6px rgba(255, 77, 106, .25); }
      50%      { box-shadow: 0 0 0 14px rgba(255, 77, 106, .08); }
    }

    #status {
      color: var(--muted);
      font-size: .82rem;
      margin-top: .5rem;
      min-height: 1.2em;
      text-align: center;
    }

    /* â”€â”€ Voice selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .voice-selector {
      width: 100%;
      max-width: 640px;
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
    }

    .voice-selector label {
      color: var(--muted);
      font-size: 0.85rem;
      font-weight: 500;
    }

    #voiceSelect {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }

    #voiceSelect:hover {
      border-color: var(--primary);
    }

    #voiceSelect:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.15);
    }

    /* â”€â”€ Voice selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .voice-selector {
      width: 100%;
      max-width: 640px;
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
    }

    .voice-selector label {
      color: var(--muted);
      font-size: 0.85rem;
      font-weight: 500;
    }

    #voiceSelect {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
    }

    #voiceSelect:hover {
      border-color: var(--primary);
    }

    #voiceSelect:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.15);
    }

    /* â”€â”€ Visualiser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #visualiser {
      width: 200px;
      height: 48px;
    }

    /* â”€â”€ Audio player (hidden) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #audioPlayer { display: none; }
  </style>
</head>
<body>

<h1>&#127908; Voice Chat</h1>
<p class="subtitle">Press Start Bot and it will listen continuously for your answers</p>

<div class="voice-selector">
  <label for="voiceSelect">ğŸ™ï¸ Voice Accent:</label>
  <select id="voiceSelect">
    <option value="en-US-AriaNeural">ğŸ‡ºğŸ‡¸ US Female (Aria) - Professional</option>
    <option value="en-US-GuyNeural">ğŸ‡ºğŸ‡¸ US Male (Guy) - Clear</option>
    <option value="en-US-JennyNeural">ğŸ‡ºğŸ‡¸ US Female (Jenny) - Friendly</option>
    <option value="en-US-ChristopherNeural">ğŸ‡ºğŸ‡¸ US Male (Christopher) - Authoritative</option>
    <option value="en-GB-SoniaNeural">ğŸ‡¬ğŸ‡§ UK Female (Sonia)</option>
    <option value="en-GB-RyanNeural">ğŸ‡¬ğŸ‡§ UK Male (Ryan)</option>
    <option value="en-AU-NatashaNeural">ğŸ‡¦ğŸ‡º Australian Female (Natasha)</option>
    <option value="en-AU-WilliamNeural">ğŸ‡¦ğŸ‡º Australian Male (William)</option>
    <option value="en-IN-NeerjaNeural">ğŸ‡®ğŸ‡³ Indian Female (Neerja)</option>
    <option value="en-IN-PrabhatNeural">ğŸ‡®ğŸ‡³ Indian Male (Prabhat)</option>
    <option value="en-CA-ClaraNeural">ğŸ‡¨ğŸ‡¦ Canadian Female (Clara)</option>
    <option value="en-CA-LiamNeural">ğŸ‡¨ğŸ‡¦ Canadian Male (Liam)</option>
  </select>
</div>

<div id="chat"></div>

<canvas id="visualiser"></canvas>

<div class="controls">
  <button id="startBtn">Start Bot</button>
  <button id="stopBtn" style="display:none; background: var(--danger);">Stop Bot</button>
  <button id="micBtn" title="Auto listening enabled after Start">&#127908;</button>
</div>
<p id="status">Ready</p>

<audio id="audioPlayer"></audio>

<form id="textForm">
  <textarea id="textInput" placeholder="Type your question..." required></textarea>
  <button type="submit">Send</button>
</form>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WS_URL = `ws://${location.host}/ws/voice`;
let ws = null;
let mediaStream = null;
let recorder = null;
let recording = false;
let audioChunks = [];       // WAV chunks received from server
let recordedChunks = [];    // WebM chunks captured from mic
let analyser, dataArray, animFrame;
let audioCtx = null;
let sourceNode = null;
let autoMode = false;
let pausedByBot = false;
let discardClip = false;
let detectedSpeech = false;
let lastSpeechTs = 0;

const SPEECH_THRESHOLD = 42;     // amplitude (0-255) to detect speech
const SILENCE_HOLD_MS = 1200;    // ms of silence before clipping ends
const AUTO_RESTART_DELAY = 400;  // delay before auto resume
const IDLE_RESET_MS = 8000;      // reset a silent clip after this many ms

const chatEl     = document.getElementById("chat");
const micBtn     = document.getElementById("micBtn");
const startBtn   = document.getElementById("startBtn");
const stopBtn    = document.getElementById("stopBtn");
const statusEl   = document.getElementById("status");
const playerEl   = document.getElementById("audioPlayer");
const canvas     = document.getElementById("visualiser");
const canvasCtx  = canvas.getContext("2d");
const textForm   = document.getElementById("textForm");
const textInput  = document.getElementById("textInput");
const voiceSelect = document.getElementById("voiceSelect");
let chatModeActive = false;
let selectedVoice = voiceSelect.value;

const updateMicButton = () => {
  if (autoMode) {
    micBtn.disabled = true;
    micBtn.classList.add("disabled");
    micBtn.innerHTML = "ğŸ›ï¸";
    micBtn.title = "Auto listening enabled";
    return;
  } else {
    micBtn.disabled = false;
    micBtn.classList.remove("disabled");
  }
  if (recording) {
    micBtn.classList.add("recording");
    micBtn.innerHTML = "â¹";
    micBtn.title = "Stop & send";
  } else {
    micBtn.classList.remove("recording");
    micBtn.innerHTML = "ğŸ™ï¸";
    micBtn.title = "Start listening";
  }
};

const buildControlPayload = () => ({ action: "end" });
const MEDIA_CONSTRAINTS = {
  audio: {
    sampleRate: 16000,
    channelCount: 1,
    echoCancellation: true,
    noiseSuppression: true,
  },
};

async function ensureMediaStream() {
  const hasLiveTrack = mediaStream?.getTracks().some((t) => t.readyState === "live");
  if (mediaStream && mediaStream.active && hasLiveTrack) {
    return mediaStream;
  }
  mediaStream = await navigator.mediaDevices.getUserMedia(MEDIA_CONSTRAINTS);
  sourceNode = null;
  analyser = null;
  dataArray = null;
  return mediaStream;
}

function ensureAnalyser() {
  if (!mediaStream) return;
  if (!audioCtx) {
    audioCtx = new AudioContext();
  }
  if (!sourceNode) {
    sourceNode = audioCtx.createMediaStreamSource(mediaStream);
  }
  if (!analyser) {
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    sourceNode.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }
}

function teardownMedia() {
  mediaStream?.getTracks().forEach((t) => t.stop());
  mediaStream = null;
  if (audioCtx) {
    audioCtx.close();
    audioCtx = null;
  }
  analyser = null;
  dataArray = null;
  sourceNode = null;
}

// â”€â”€ Voice selector change handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
voiceSelect.addEventListener('change', (e) => {
  selectedVoice = e.target.value;
  console.log('Voice changed to:', selectedVoice);
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ action: 'set_voice', voice: selectedVoice }));
    addMessage('system', `ğŸ™ï¸ Voice changed to: ${e.target.selectedOptions[0].text}`);
  }
});

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS() {
  ws = new WebSocket(WS_URL);
  ws.binaryType = "arraybuffer";

  ws.onopen  = () => {
    setStatus("Connected");
    // Send initial voice preference
    ws.send(JSON.stringify({ action: 'set_voice', voice: selectedVoice }));
  };
  ws.onclose = () => {
    setStatus("Disconnected â€” reconnectingâ€¦");
    autoMode = false;
    pausedByBot = false;
    if (recording) {
      stopRecording(true);
    } else {
      teardownMedia();
    }
    setStatus("Disconnected â€” reconnectingâ€¦");
    startBtn.disabled = false;
    startBtn.textContent = "Start Bot";
    updateMicButton();
    setTimeout(connectWS, 2000);
  };
  ws.onerror = () => ws.close();

  stopBtn.onclick = () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ action: "stop" }));
      addMessage("system", "Stopping bot...");
    }
    autoMode = false;
    if (recording) stopRecording(true);
    startBtn.disabled = true;
    stopBtn.disabled = true;
    setStatus("Session ended. Refresh to start over.");
  };

  ws.onmessage = (evt) => {
    if (evt.data instanceof ArrayBuffer) {
      // Binary audio chunk from TTS
      audioChunks.push(evt.data);
      return;
    }

    const msg = JSON.parse(evt.data);

    if (msg.type === "status") {
      setStatus(msg.text);
    } else if (msg.type === "audio_start") {
      audioChunks = [];
      pausedByBot = true;
      if (recording) {
        stopRecording(true);
      }
    } else if (msg.type === "audio_end") {
      playAudioChunks();
    } else if (msg.type === "transcript") {
      if (msg.text) addMessage("user", msg.text);
    } else if (msg.type === "llm_text") {
      addMessage("assistant", msg.text);
    } else if (msg.type === "chat_mode_enabled") {
      chatModeActive = true;
      setStatus("ğŸ‰ Qualification complete! You can now ask me anything.");
      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
    } else if (msg.type === "done") {
      setStatus("Session ended. Refresh to start over.");
      autoMode = false;
      if (recording) stopRecording(true);
      startBtn.disabled = true;
      stopBtn.disabled = true;
      micBtn.disabled = true;
    } else if (msg.type === "error") {
      addMessage("system", `âš  ${msg.text}`);
      setStatus("Ready");
    } else if (msg.type === "classification") {
      addMessage("system", `ğŸ“Š Classification: ${msg.text}`);
    }
  };
}

// â”€â”€ Audio playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playAudioChunks() {
  if (!audioChunks.length) return;
  const blob = new Blob(audioChunks, { type: "audio/wav" });
  audioChunks = [];
  const url = URL.createObjectURL(blob);
  playerEl.src = url;
  playerEl.play().catch(() => {});
  playerEl.onended = () => {
    URL.revokeObjectURL(url);
    pausedByBot = false;
    if (autoMode && !recording) {
      setTimeout(() => {
        if (autoMode && !recording && !pausedByBot) {
          startRecording();
        }
      }, AUTO_RESTART_DELAY);
    }
  };
}

// â”€â”€ Recording â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startRecording() {
  if (recording || pausedByBot) return;

  try {
    await ensureMediaStream();
    ensureAnalyser();
  } catch (err) {
    addMessage("system", "Microphone access denied.");
    autoMode = false;
    startBtn.disabled = false;
    startBtn.textContent = "Start Bot";
    updateMicButton();
    return;
  }

  recording = true;
  detectedSpeech = false;
  discardClip = false;
  recordedChunks = [];
  lastSpeechTs = performance.now();
  updateMicButton();
  setStatus(autoMode ? "Listening for your answerâ€¦" : "Listeningâ€¦ click again to send");

  if (!dataArray) {
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }
  drawVisualiser();

  const currentRecorder = new MediaRecorder(mediaStream, { mimeType: "audio/webm;codecs=opus" });
  recorder = currentRecorder;
  currentRecorder.ondataavailable = (e) => {
    if (e.data.size > 0) {
      recordedChunks.push(e.data);
    }
  };
  currentRecorder.addEventListener("stop", async () => {
    try {
      let sentAudio = false;
      if (!discardClip && recordedChunks.length && ws?.readyState === WebSocket.OPEN) {
        const blob = new Blob(recordedChunks, { type: currentRecorder.mimeType || "audio/webm;codecs=opus" });
        const buffer = await blob.arrayBuffer();
        ws.send(buffer);
        sentAudio = true;
      } else if (!discardClip && !autoMode) {
        addMessage("system", "No audio captured. Please try again.");
      }

      if (sentAudio && ws?.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(buildControlPayload()));
      }
    } catch (err) {
      if (!discardClip) {
        addMessage("system", `Failed to process audio: ${err.message}`);
      }
    } finally {
      recordedChunks = [];
      recorder = null;
      if (!autoMode) {
        teardownMedia();
      }
      const shouldRestart = autoMode && !pausedByBot;
      discardClip = false;
      if (shouldRestart) {
        setTimeout(() => {
          if (autoMode && !recording && !pausedByBot) {
            startRecording();
          }
        }, AUTO_RESTART_DELAY);
      }
    }
  });
  currentRecorder.start();
}

function stopRecording(discard = false) {
  if (!recording || !recorder) return;
  recording = false;
  discardClip = discard;
  detectedSpeech = false;
  updateMicButton();
  cancelAnimationFrame(animFrame);
  clearCanvas();

  if (recorder.state !== "inactive") {
    recorder.stop();
  }

  if (!discard) {
    setStatus(autoMode ? "Processing your answerâ€¦" : "Transcribingâ€¦");
  } else {
    const msg = pausedByBot ? "Assistant speakingâ€¦" : "Listening for your answerâ€¦";
    setStatus(msg);
  }
}

// â”€â”€ Visualiser drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawVisualiser() {
  if (!analyser) return;
  animFrame = requestAnimationFrame(drawVisualiser);
  analyser.getByteFrequencyData(dataArray);

  const W = canvas.width, H = canvas.height;
  canvasCtx.clearRect(0, 0, W, H);

  const barW = (W / dataArray.length) * 2.5;
  let x = 0;
  for (let i = 0; i < dataArray.length; i++) {
    const barH = (dataArray[i] / 255) * H;
    canvasCtx.fillStyle = `rgba(108, 99, 255, ${0.4 + dataArray[i] / 255 * 0.6})`;
    canvasCtx.fillRect(x, H - barH, barW - 1, barH);
    x += barW;
  }

  if (recording && autoMode) {
    const avg = dataArray.reduce((sum, val) => sum + val, 0) / dataArray.length;
    const now = performance.now();
    if (avg > SPEECH_THRESHOLD) {
      detectedSpeech = true;
      lastSpeechTs = now;
    } else if (detectedSpeech && now - lastSpeechTs > SILENCE_HOLD_MS) {
      stopRecording();
    } else if (!detectedSpeech && now - lastSpeechTs > IDLE_RESET_MS) {
      stopRecording(true);
    }
  }
}

function clearCanvas() {
  canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
}

// â”€â”€ Chat helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addMessage(role, text) {
  const div = document.createElement("div");
  div.className = `msg ${role}`;
  div.textContent = text;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function setStatus(text) { statusEl.textContent = text; }

// â”€â”€ Text chat submission â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
textForm.addEventListener("submit", (evt) => {
  evt.preventDefault();
  const query = textInput.value.trim();
  if (!query || ws?.readyState !== WebSocket.OPEN) return;

  addMessage("user", query);
  ws.send(JSON.stringify({ action: "text_answer", text: query }));
  textInput.value = "";
});

startBtn.addEventListener("click", async () => {
  if (ws?.readyState !== WebSocket.OPEN) {
    setStatus("Connectingâ€¦ please wait");
    return;
  }

  setStatus("Starting conversation...");
  
  // Send initial voice selection
  const currentVoice = voiceSelect.value;
  ws.send(JSON.stringify({ action: "set_voice", voice: currentVoice }));
  addMessage('system', `ğŸ™ï¸ Voice set to: ${voiceSelect.selectedOptions[0].text}`);
  
  // Start the conversation
  ws.send(JSON.stringify({ action: "start" }));
  autoMode = true;
  updateMicButton();
  startBtn.disabled = true;
  startBtn.textContent = "Bot Running";

  if (!pausedByBot && !recording) {
    await startRecording();
  }
});

// â”€â”€ Button events (press & hold) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleRecording(e) {
  e?.preventDefault();
  if (autoMode) return;
  if (recording) {
    stopRecording();
  } else {
    startRecording();
  }
}

micBtn.addEventListener("click", toggleRecording);
micBtn.addEventListener("touchend", toggleRecording);

updateMicButton();

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
connectWS();
</script>
</body>
</html>
